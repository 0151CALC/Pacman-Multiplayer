<html>

    <head>

        <title>Mulitplayer Pacman</title>

        <style>

            body {
                background-color: lightgray;
                font-family: Trebuchet MS;
            }

            h2 {
                font-size: 5vw;
                text-align: center;
                margin: 0;
                margin-bottom: 25px;
            }

            h4 {
                font-size: 25px;
                text-align: center;
                margin: 0;
                margin-bottom: 5px;
                font-weight: normal;
                color: gray;
            }

            #username {
                height: 50px;
                width: 500px;
                display: block;
                margin: 0 auto;
                border: none;
                padding: 15px;
                font-size: 25px;
                text-align: center;
                border: 1px solid black;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }


            #username:focus {
                outline: none;
            }

            #hostContainer {
                width: 487.5px;
                height: 70px;
                margin: 0 auto;
                border: 1px solid black;
                border-top: none;
                background-color: white;
                padding: 5px;
                z-index: 5;
                position: relative;
            }

            #gamecodeInput {
                height: 50px;
                width: 500px;
                display: block;
                margin: 0 auto;
                border: none;
                padding: 15px;
                font-size: 25px;
                text-align: center;
                border: 1px solid black;
                border-top: none;
                z-index: 3;
                position: relative;
                transition: 0.4s;
            }

            #submitButton {
                height: 50px;
                width: 500px;
                display: block;
                margin: 0 auto;
                background-color: #28a745;
                border: 1px solid green;
                border-radius: 5px;
                margin-top: 10px;
                color: white;
                font-size: 25px;
                transition: .4s;
            }

            #errorContainer {
                height: 50px;
                width: 500px;
                display: none;
                margin: 0 auto;
                background-color: #dc3545;
                border-radius: 5px;
                margin-top: 10px;
                color: white;
                font-size: 25px;
                text-align: center;
                line-height: 50px;
            }

            #gameContentContainer {
                width: 95%;
                height: 800px;
                margin: 0 auto;
                display: none;
            }

            #leftPanelContainer {
                height:700px;
                width:50%;
                clear:none;
                float: left;
                margin-right:-450px;
            }

            #rightPanelContainer {
                height:700px;
                width:50%;
                clear:none;
                float: right;
                margin-left:-450px;
            }

            #gamePanelContainer {
                /*background-color: green; */
                width: 900px;
                height : 700px;
                clear:none;
                float: left;
            }

            #leftPanelContainer>div {
                padding-right: 462px;
            }

            #rightPanelContainer>div {
                padding-left: 462px; /* 10px added for seperation between side panels and main center panel. And 2px added for the 2px border of the side panel items. */
            }

            #leftPanelContent {
                height: 100%;
            }

            #leftPanelContent>div {
                width: 100%;
                border-radius: 5px;
                margin-bottom: 10px;
            }

            #rightPanelContent {
                height: 100%;
            }

            #gameChat {
                height: 458px;
                width: 100%;
                border-top-right-radius: 5px;
                border-top-left-radius: 5px;
                resize: none;
                border: 1px solid black;
                border-bottom: 0;
                padding: 10px;
            }

            #chatOptionsContainer {
                width: 100%;
                display: flex;
            }

            #inputField {
                border: 1px solid black;
                padding: 0;
                margin: 0;
                flex-grow: 1;
                padding: 5px;
                border-right: 0;
            }

            #chatSubmitButton {
                border: 1px solid black;
                padding: 0;
                margin: 0;
                width: 80px;
                background-color: #28a745;
                color: white;
            }

            #gamecodeTextContainer {
                height: 100px;
                text-align: center;
                line-height: 50px;
                background-color: white;
                border: 1px solid black;
            }

            #playersInGameContainer {
                height: 300px;
                background-color: white;
                border: 1px solid black;
            }

            .listSlot {
                width: 100%;
                height: 50px;
                text-align: center;
                line-height: 50px;
                font-size: 25px;
            }

            #leaveGameButton {
                width: 100%;
                border-radius: 5px;
                margin-bottom: 10px;
                height: 50px;
                background-color: #dc3545;
                border: 1px solid #dc3545;
                text-align: center;
                line-height: 50px;
                color: white;
                font-size: 25px;
            }

            #copyInviteLink {
                width: 100%;
                border-radius: 5px;
                margin-bottom: 10px;
                height: 50px;
                background-color: #17a2b8;
                border: 1px solid #17a2b8;
                text-align: center;
                line-height: 50px;
                color: white;
                font-size: 25px;
            }

            table {
                width: 100%;
                height: 100%;
                border-collapse: separate;

            }

            td {
                border: 1px solid black;
            }

            /* The switch - the box around the slider */
            .switch {
                position: relative;
                display: block;
                width: 120px;
                height: 34px;
                margin: 0 auto;
            }

            /* Hide default HTML checkbox */
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            /* The slider */
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #dc3545;
                -webkit-transition: .4s;
                transition: .4s;
                border-radius: 5px;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 52px;
                left: 8px;
                bottom: 4px;
                background-color: white;
                -webkit-transition: .4s;
                transition: .4s;
                border-radius: 5px;
            }

            input:checked + .slider {
                background-color: #28a745;
            }

            input:checked + .slider:before {
                -webkit-transform: translateX(52px);
                -ms-transform: translateX(52px);
                transform: translateX(52px);
            }

            /* Rounded sliders */
            .slider.round {
                border-radius: 34px;
            }

            .slider.round:before {
                border-radius: 50%;
            }


        </style>

    </head>

    <body>

        <h2>

            Multiplayer Pacman!

        </h2>




        <form ID="mainForm" action="">
            <input ID="username" type="text" spellcheck="false" autocorrect="off" autocomplete="off" autofocus="autofocus" placeholder="Enter a Username" minlength="3" maxlength="14" required>
            <div ID="hostContainer">
                <h4>Host a game?</h4>
                <label class="switch">
                    <input ID="hostCheckbox" type="checkbox" onchange="setHost()">
                    <span class="slider"></span>
                </label>
            </div>
            <input ID="gamecodeInput" type="text" spellcheck="false" autocorrect="off" autocomplete="off" autofocus="autofocus" placeholder="Enter the Game Code" onchange="document.getElementById('gamecodeInput').style.color = 'black'" onkeyup="this.onchange();" onpaste="this.onchange();" oninput="this.onchange();" minlength="4" maxlength="4" required>
            <input ID="submitButton" type="submit" value="Play!">
            <div ID="errorContainer"></div>
        </form>

        <div ID="gameContentContainer">

            <div ID="leftPanelContainer">
                <div ID="leftPanelContent">
                    <div ID="gamecodeTextContainer">
                        <div class="listSlot">
                            Game Room:
                        </div>
                        <div class="listSlot" ID="gamecodeText">

                        </div>
                    </div>
                    <div ID="playersInGameContainer">
                        <div class="listSlot" ID="keep">
                            Players in Game:
                        </div>
                    </div>
                    <input ID="copyInviteLink" value="Get Invite Link" type="button" onclick="copyInviteLink()" />
                    <input ID="leaveGameButton" value="Leave Game" type="button" onclick="leaveGame()" />

                </div>
            </div>
            <div ID="rightPanelContainer">
                <div ID="rightPanelContent">
                    <textarea readonly ID="gameChat"></textarea>
                    <div ID="chatOptionsContainer">
                        <input ID="inputField" type="text" autocomplete="off" autofocus="autofocus">
                        <input ID="chatSubmitButton" type="submit" value="Submit">
                    </div>
                </div>
            </div>
            <div ID="gamePanelContainer">

            </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script>

            var socket = io.connect();

            var localName;
            var gamecode;

            var wantsToHost = false

            urlParams = new URLSearchParams(window.location.search);

            if (urlParams.has('gamecode')) {
                document.getElementById("gamecodeInput").value = urlParams.get('gamecode');
            }

            function setHost() {
                document.getElementById("errorContainer").style.display = "none";
                document.getElementById("gamecodeInput").value = "";
                if (document.getElementById("hostCheckbox").checked) {
                    document.getElementById("gamecodeInput").style.transform = "translateY(-50px)";
                    document.getElementById("submitButton").style.transform = "translateY(-50px)";
                    document.getElementById("gamecodeInput").removeAttribute("required")
                    wantsToHost = true
                } else {
                    document.getElementById("gamecodeInput").style.transform = "translateY(0px)";
                    document.getElementById("submitButton").style.transform = "translateY(0px)";
                    document.getElementById("gamecodeInput").setAttribute("required", "true")
                    wantsToHost = false
                }
            }

            function createPlayerSlot(name, keep) {
                listContainer = document.getElementById("playersInGameContainer");

                newPlayerDiv = document.createElement('div');

                newPlayerDiv.className = 'listSlot';

                if (keep) {
                    newPlayerDiv.id = 'keep';
                }

                newPlayerDiv.innerHTML = name;

                listContainer.appendChild(newPlayerDiv);
            }

            function copyInviteLink() {

                console.log('copyingggg')

                var temp = document.createElement('textarea');
                var url = window.location.href.split('?')[0];

                temp.value = url + "?gamecode=" + gamecode;
                temp.setAttribute('readonly', '');
                temp.style = {position: 'absolute', left: '-9999px'};

                document.body.appendChild(temp);

                temp.select();
                temp.setSelectionRange(0, 99999);

                document.execCommand('copy');
                document.body.removeChild(temp);

                document.getElementById("copyInviteLink").value = "Copied!";

            }

            function leaveGame() {
                socket.emit('leaveGame');

                while (document.getElementById("playersInGameContainer").lastChild) {
                    document.getElementById("playersInGameContainer").removeChild(document.getElementById("playersInGameContainer").lastChild);
                }

                document.getElementById("mainForm").style.display = "block";
                document.getElementById("gameContentContainer").style.display = "none";

            }

            function build() {
                gameContainer = document.getElementById("gamePanelContainer");

                gameContainer.innerHTML = ""

                var cellSizeInPX = 25;

                var numOfHorizontalCells = gameContainer.offsetWidth / cellSizeInPX;
                var numOfVerticalCells = gameContainer.offsetHeight / cellSizeInPX;

                var gameTable = document.createElement('table');

                for (i = 0; i < numOfVerticalCells; i++) {

                    var row = document.createElement("tr");
                    gameTable.appendChild(row);

                    for (j = 0; j < numOfHorizontalCells; j++) {
                        var col = document.createElement("td");
                        col.style.width = cellSizeInPX;
                        col.style.height = cellSizeInPX;
                        col.id = "r" + i + "c" + j;
                        col.dataset.visited = false;
                        row.appendChild(col);
                    }
                }

                gameContainer.appendChild(gameTable);

                createMaze();

                function createMaze() {
                    for (i = 0; i < numOfVerticalCells; i++) {
                        for (j = 0; j < numOfHorizontalCells; j++) {

                            cell = document.getElementById("r" + i + "c" + j)

                            console.log(checkNeighbours(i,j))


                            //removeWall(i,j);
                        }
                    }

                    function checkNeighbours(row, col) {
                        var neighbours = []
                        var neighbour;

                        if (row != 0 && row != (numOfHorizontalCells - 1) && col != 0 && col != (numOfVerticalCells - 1)) {
                            checkNeighbour("right");
                            checkNeighbour("left");
                            checkNeighbour("top");
                            checkNeighbour("bottom");
                        }

                        return neighbours

                        function checkNeighbour(dir) {
                            switch (dir) {
                                case "right":
                                    neighbour = document.getElementById("r" + row + "c" + (col + 1));
                                    if (neighbour.dataset.visited == "false") { neighbours.push(neighbour) }
                                    break;
                                case "left":
                                    neighbour = document.getElementById("r" + row + "c" + (col - 1));
                                    if (neighbour.dataset.visited == "false") { neighbours.push(neighbour) }
                                    break;
                                case "top":
                                    neighbour = document.getElementById("r" + (row + 1) + "c" + col);
                                    if (neighbour.dataset.visited == "false") { neighbours.push(neighbour) }
                                    break;
                                case "bottom":
                                    neighbour = document.getElementById("r" + (row - 1) + "c" + col);
                                    if (neighbour.dataset.visited == "false") { neighbours.push(neighbour) }
                                    break;
                            }
                        }
                    }

                    // write a funciton called avaliableDirections and have it return all the valid directions that the cell is able to make. This will replace the junky code below and make the code more reuseable.

                    function removeWall(row, col) {

                        var cell = document.getElementById("r" + row + "c" + col)
                        var cell2;

                        if (row == 0) {
                            if (col == 0) {
                                if (Math.random >= 0.5) {
                                    removeWallDir("right")
                                } else {
                                    removeWallDir("bottom")
                                }
                            } else if (col == numOfHorizontalCells - 1) {
                                if (Math.random >= 0.5) {
                                    removeWallDir("left")
                                } else {
                                    removeWallDir("bottom")
                                }
                            } else {
                                var rannum = Math.random();
                                if (rannum <= 0.33) {
                                    removeWallDir("left")
                                } else if (rannum <= 0.66) {
                                    removeWallDir("right")
                                } else {
                                    removeWallDir("bottom")
                                }
                            }
                        } else if (row == numOfVerticalCells - 1) {
                            if (col == 0) {
                                if (Math.random >= 0.5) {
                                    removeWallDir("right")
                                } else {
                                    removeWallDir("top")
                                }
                            } else if (col == numOfHorizontalCells - 1) {
                                if (Math.random >= 0.5) {
                                    removeWallDir("left")
                                } else {
                                    removeWallDir("top")
                                }
                            } else {
                                var rannum = Math.random();
                                if (rannum <= 0.33) {
                                    removeWallDir("left")
                                } else if (rannum <= 0.66) {
                                    removeWallDir("right")
                                } else {
                                    removeWallDir("top")
                                }
                            }
                        } else {
                            if (col == 0) {
                                var rannum = Math.random();
                                if (rannum <= 0.33) {
                                    removeWallDir("bottom")
                                } else if (rannum <= 0.66) {
                                    removeWallDir("right")
                                } else {
                                    removeWallDir("top")
                                }
                            } else if (col == numOfHorizontalCells - 1) {
                                var rannum = Math.random();
                                if (rannum <= 0.33) {
                                    removeWallDir("bottom")
                                } else if (rannum <= 0.66) {
                                    removeWallDir("left")
                                } else {
                                    removeWallDir("top")
                                }
                            } else {
                                var rannum = Math.random();
                                if (rannum <= 0.25) {
                                    removeWallDir("top")
                                } else if (rannum <= 0.5) {
                                    removeWallDir("bottom")
                                } else if (rannum <= 0.75) {
                                    removeWallDir("left")
                                } else {
                                    removeWallDir("right")
                                }
                            }
                        }

                        function removeWallDir(dir) {
                            switch(dir) {
                                case "left":
                                    cell.style.borderLeft = "none";
                                    cell2 = document.getElementById("r" + row + "c" + (col - 1))
                                    cell2.style.borderRight = "none";
                                    break;
                                case "right":
                                    cell.style.borderRight = "none";
                                    cell2 = document.getElementById("r" + row + "c" + (col + 1))
                                    cell2.style.borderLeft = "none";
                                    break;
                                case "bottom":
                                    cell.style.borderBottom = "none";
                                    cell2 = document.getElementById("r" + (row + 1) + "c" + col)
                                    cell2.style.borderTop = "none";
                                    break;
                                case "top":
                                    cell.style.borderTop = "none";
                                    cell2 = document.getElementById("r" + (row - 1) + "c" + col)
                                    cell2.style.borderBottom = "none";
                                    break;
                            }
                        }
                    }

                }
            }


            $('#mainForm').submit(function(event){

                localName = document.getElementById("username").value;
                gamecode = document.getElementById("gamecodeInput").value;

                socket.emit('joinGame', {
                    name: localName,
                    wantsToHost: wantsToHost,
                    gameCode: gamecode
                });


                return false;
            });

            socket.on('displayErrorMsg', function(data) {
                document.getElementById("gamecodeInput").style.color = "red";
                document.getElementById("errorContainer").style.display = "block";
                document.getElementById("errorContainer").innerHTML = data.msg;
            })

            socket.on('gameSetup', function(data) {

                console.log("successfully joined room: " + data.gameCode);
                document.getElementById("mainForm").style.display = "none";
                document.getElementById("gameContentContainer").style.display = "block";
                document.getElementById("gamecodeText").innerHTML = data.gameCode;
                gamecode = data.gameCode;
                createPlayerSlot(localName, true);



            })

            socket.on('updatePlayersInGame', function(data) {
                playersInGame = data.playersInGame;

                console.log(playersInGame);

                while (document.getElementById("playersInGameContainer").lastChild.id !== 'keep') {
                    document.getElementById("playersInGameContainer").removeChild(document.getElementById("playersInGameContainer").lastChild);
                }

                for (i = 0; i < playersInGame.length; i++) {
                    if (playersInGame[i] != localName) {
                        createPlayerSlot(playersInGame[i], false);
                    }
                }
            })


        </script>
    </body>

</html>
